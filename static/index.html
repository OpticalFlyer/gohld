<!DOCTYPE html>
<html>
<head>
    <title>High-Level Design Tool</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="/static/styles.css"/>
</head>
<body>
    <div id="container">
        <div id="toolbar">
            <button id="toggle-sidebar" class="toolbar-button">☰</button>
            <!-- Logout Button -->
            <button id="logout-button" class="toolbar-button">⇦</button>
        </div>

        <div id="map"></div>
    </div>

    <div id="sidebar">
        <button id="create-map-button">Create Map</button>
        <ul>
            <li><input type="checkbox" id="map1-checkbox" /><label for="map1-checkbox">Map 1</label></li>
            <li><input type="checkbox" id="map2-checkbox" /><label for="map2-checkbox">Map 2</label></li>
            <li><input type="checkbox" id="map3-checkbox" /><label for="map3-checkbox">Map 3</label></li>
        </ul>
    </div>

    <div id="login-dialog-container">
        <div id="login-dialog">
            <div id="login-header">
                <h2>Log In</h2>
            </div>
            <div id="login-form">
                <form id="loginForm">
                    <input type="text" id="emailInput" placeholder="yours@example.com" required />
                    <input type="password" id="passwordInput" placeholder="your password" required />
                    <div id="forgot-password">Don't remember your password?</div>
                    <button type="submit">LOG IN</button>
                </form>
            </div>
        </div>
    </div>    

    <script src="/static/sidebar.js"></script>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css"/>
    <script>
        var loggedin = false;

        document.addEventListener('DOMContentLoaded', (event) => {
    var loginForm = document.getElementById('loginForm');

    loginForm.addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent the form from submitting the default way

        var email = document.getElementById('emailInput').value;
        var password = document.getElementById('passwordInput').value;

        // Create an object with the email and password
        var loginCredentials = {
            username: email, // Assuming the backend expects 'username'
            password: password
        };

        // Use the fetch API to send a POST request to /login
        fetch('/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json', // Specify the content type as JSON
            },
            body: JSON.stringify(loginCredentials) // Convert the credentials object to a JSON string
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Failed to log in');
            }
        })
        .then(data => {
            loggedin = true; // Set the logged in state to true
            toggleLoginDialog(); // Update the UI to reflect the logged in state
            // Handle any additional login success actions here
        })
        .catch(error => {
            console.error('Error during login:', error);
            // Handle login errors (show error message to the user, etc.)
        });
    });
});

function logout() {
    fetch('/logout', {
        method: 'POST',
        credentials: 'include' // Necessary to include cookies for the session
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            throw new Error('Logout failed');
        }
    })
    .then(data => {
        console.log(data.message); // Or handle the logout success message in the UI
        checkLoginStatus(); // Check login status to update UI
    })
    .catch(error => {
        console.error('Error during logout:', error);
        // Optionally handle logout errors in the UI
    });
}

document.addEventListener('DOMContentLoaded', (event) => {
    // ... (other event listeners)

    var logoutButton = document.getElementById('logout-button');
    logoutButton.addEventListener('click', function(event) {
        logout();
    });
});

        // Function to check login status
        function checkLoginStatus() {
            fetch('/check-auth')
                .then(response => {
                    // If the response is successful, assume the user is logged in
                    if (response.ok) {
                        return response.json();  // Parse the JSON response
                    } else {
                        // If the response is not successful, assume the user is not logged in
                        throw new Error('Not logged in');
                    }
                })
                .then(data => {
                    // Update the login state based on the response
                    loggedin = data.authenticated;
                    toggleLoginDialog(); // Update the login dialog visibility
                })
                .catch(error => {
                    console.error('Error checking login status:', error);
                    loggedin = false;
                    toggleLoginDialog(); // Ensure the login dialog is shown if not logged in
                });
        }

        // Function to toggle the login dialog visibility
        function toggleLoginDialog() {
            var loginDialog = document.getElementById('login-dialog-container');
            if (loggedin) {
                loginDialog.style.display = 'none'; // Hide it
            } else {
                loginDialog.style.display = 'flex'; // Show it, since the container is flex
            }
        }

        // Call the function to check the initial login status
        checkLoginStatus();

        function setVH() {
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        window.addEventListener('resize', setVH);
        window.addEventListener('orientationchange', setVH);

        // Initial set
        setVH();

        // Create the map centered on the United States
        var map = L.map('map').setView([39.8283, -98.5795], 4);

        // Add the Google Maps tile layer
        L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{
            maxZoom: 20,
            subdomains:['mt0','mt1','mt2','mt3']
        }).addTo(map);

        // Initialize the draw control and pass it the FeatureGroup of editable layers
        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var drawControl = new L.Control.Draw({
            draw: {
                polyline: false,
                polygon: false,
                circle: false,
                marker: false,
                circlemarker: false,
                rectangle: {
                    shapeOptions: {
                        color: '#f357a1',
                        fillOpacity: 0.5
                    }
                }
            },
            edit: false
        });
        map.addControl(drawControl);

        // Change the tooltip of the rectangle button
        var drawRectangleButton = document.querySelector('.leaflet-draw-draw-rectangle');
        if (drawRectangleButton) {
            drawRectangleButton.title = 'Import road centerlines';
            drawRectangleButton.children[0].title = 'Import road centerlines';
        }

        var selectMode = false;

        // Create a new control for the "Select Roads" button and add it to the map
        var SelectControl = L.Control.extend({
            options: {
                position: 'topleft'
            },

            onAdd: function (map) {
                var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                container.style.backgroundColor = 'white';
                container.style.width = '30px';
                container.style.height = '30px';
                container.style.display = 'flex';
                container.style.alignItems = 'center';
                container.style.justifyContent = 'center';
                container.style.cursor = 'pointer';

                var icon = L.DomUtil.create('i', 'icon', container);
                icon.textContent = 'S';
                icon.title = 'Select Roads';

                container.onclick = function () {
                    selectMode = !selectMode;
                    icon.style.color = selectMode ? 'red' : '#404040';
                };

                return container;
            }
        });

        map.addControl(new SelectControl());

        // Create a new control for the "Delete Selected Roads" button and add it to the map
        var DeleteControl = L.Control.extend({
            options: {
                position: 'topleft'
            },

            onAdd: function (map) {
                var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                container.style.backgroundColor = 'white';
                container.style.width = '30px';
                container.style.height = '30px';
                container.style.display = 'flex';
                container.style.alignItems = 'center';
                container.style.justifyContent = 'center';
                container.style.cursor = 'pointer';

                var icon = L.DomUtil.create('i', 'icon', container);
                icon.textContent = 'D';
                icon.title = 'Delete Selected Roads';

                container.onclick = function () {
                    map.eachLayer(function (layer) {
                        if (layer instanceof L.Path && layer.options.color === 'red') {
                            map.removeLayer(layer);
                        }
                    });
                };

                return container;
            }
        });

        map.addControl(new DeleteControl());

        // Create a new control for the "Download GeoJSON" button and add it to the map
        var DownloadControl = L.Control.extend({
            options: {
                position: 'topleft'
            },

            onAdd: function (map) {
                var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                container.style.backgroundColor = 'white';
                container.style.width = '30px';
                container.style.height = '30px';
                container.style.display = 'flex';
                container.style.alignItems = 'center';
                container.style.justifyContent = 'center';
                container.style.cursor = 'pointer';

                var icon = L.DomUtil.create('i', 'icon', container);
                icon.textContent = 'G';
                icon.title = 'Download GeoJSON';

                container.onclick = function () {
                    var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(geojson));
                    var downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", "centerlines.geojson");
                    document.body.appendChild(downloadAnchorNode); // required for firefox
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                };

                return container;
            }
        });

        map.addControl(new DownloadControl());

        var geojson;

        map.on('draw:created', function (e) {
        var type = e.layerType,
            layer = e.layer;

        if (type === 'rectangle') {
            var bounds = layer.getBounds();
            var south = bounds.getSouth();
            var west = bounds.getWest();
            var north = bounds.getNorth();
            var east = bounds.getEast();

            // Use the backend endpoint to get the road centerlines
            var requestData = {
                south: south,
                west: west,
                north: north,
                east: east
            };

            // Query the backend
            fetch('/road-centerline', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                geojson = data; // The backend sends back GeoJSON directly

                // Add the road centerlines to the map
                L.geoJSON(geojson, {
                    onEachFeature: function (feature, layer) {
                        layer.on('click', function () {
                            if (selectMode) {
                                layer.setStyle({color: 'red'});
                            } else {
                                // Generate the popup content
                                var popupContent = '<pre>' + JSON.stringify(feature.properties, null, 2) + '</pre>';

                                // Bind the popup to the layer
                                layer.bindPopup(popupContent).openPopup();
                            }
                        });
                    }
                }).addTo(map);

                // Remove the bounding box from the map
                map.removeLayer(layer);
            })
            .catch(err => {
                console.error('Error fetching data:', err);
            });
        }

        drawnItems.addLayer(layer);
    });

    var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var drawControl = new L.Control.Draw({
            draw: {
                polyline: false,
                polygon: false, // Initially, we'll disable it here, and enable it with the custom button
                circle: false,
                marker: false,
                circlemarker: false,
                rectangle: false
            },
            edit: false
        });
        map.addControl(drawControl);

        // Create a custom control for the "Draw Polygon to Fetch Sites" button and add it to the map
        var DrawPolygonControl = L.Control.extend({
            options: {
                position: 'topleft'
            },

            onAdd: function (map) {
                var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                container.style.backgroundColor = 'white';
                container.style.width = '30px';
                container.style.height = '30px';
                container.style.display = 'flex';
                container.style.alignItems = 'center';
                container.style.justifyContent = 'center';
                container.style.cursor = 'pointer';

                var icon = L.DomUtil.create('i', 'icon', container);
                icon.textContent = 'Sites';
                icon.title = 'Draw Polygon to Fetch Sites';

                container.onclick = function () {
                    new L.Draw.Polygon(map, drawControl.options.draw.polygon).enable();
                };

                return container;
            }
        });

        map.addControl(new DrawPolygonControl());

        map.on('draw:created', function (e) {
            var type = e.layerType,
                layer = e.layer;

            if (type === 'polygon') {
                var polygonCoords = layer.getLatLngs()[0];
                var requestData = {
                    polygon: polygonCoords.map(coord => [coord.lat, coord.lng])
                };

                // Query the backend
                fetch('/sites-in-polygon', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                })
                .then(response => response.json())
                .then(data => {
                    var sitesLayer = L.geoJSON(data, {
                        pointToLayer: function(feature, latlng) {
                            return L.circleMarker(latlng, {
                                radius: 5, // size of the circle marker
                                fillColor: "#ff7800", // color of the circle marker
                                color: "#000",
                                weight: 1,
                                opacity: 1,
                                fillOpacity: 0.8
                            });
                        },
                        onEachFeature: function (feature, layer) {
                            if (feature.properties && feature.properties.popupContent) {
                                layer.bindPopup(feature.properties.popupContent);
                            }
                        }
                    }).addTo(map);

                    // Remove the bounding box from the map
                    map.removeLayer(layer);
                })
                .catch(err => {
                    console.error('Error fetching data:', err);
                });
            }

            drawnItems.addLayer(layer);
        });
    </script>
</body>
</html>
